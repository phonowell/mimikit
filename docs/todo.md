# 迁移方案（V2）：用 OpenCode 替代自研 Manager 智能层

## 决策结论

采用 OpenCode 替代自研 manager 的智能编排能力，但不替代本地执行状态机。

- 应替代：对话理解、工具决策、上下文管理、回复生成。
- 必保留：任务状态、队列一致性、Cron、Worker 调度、WebUI 状态投影、安全边界。

这不是“全量替换 manager”，而是“分层替换智能层”。

## 产品定位与依赖策略

1. **不造轮子**
   - 直接复用 OpenCode/Codex 的现成智能能力，不再扩张自研对话编排层。
2. **mimikit 的定位**
   - 作为持久化工作系统，负责任务、调度、状态收敛与可观测性。
3. **OpenCode 的角色（必选主路径）**
   - 主 session 的默认引擎与成本优先路径。
   - 在当前架构中为必需依赖，承担主要编排职责。
4. **Codex 的角色（可选增强）**
   - 仅在复杂或高要求场景启用，作为能力增强层。
   - 不是系统可运行的前提条件。
5. **依赖治理原则**
   - OpenCode 主路径异常时允许降级策略，避免单点故障影响整体服务连续性。

## 设计原则

1. **单一职责**
   - OpenCode 负责“理解与编排”。
   - mimikit 负责“执行与收敛”。
2. **状态真相本地化**
   - 任务与调度状态以本地运行态为唯一真相。
3. **事件驱动**
   - 会话与执行通过事件桥接，不做同步强耦合。
4. **可回退**
   - 采用版本级回退，不引入运行期兼容层。

## 能力边界

### OpenCode（上层）

- 主会话生命周期管理
- 意图理解与工具调用决策
- 回复生成与交互连贯性
- 会话级错误恢复策略

### mimikit（下层）

- 任务队列与生命周期管理
- Worker 并发、超时、重试、取消收敛
- Cron/定时触发
- WebUI 实时状态与观测
- 安全策略与运行约束

## 不可替代能力与原因

1. **本地状态恢复**
   - 重启后任务状态必须准确恢复，不能依赖会话文本重建。
2. **消费一致性**
   - 输入与结果只能被正确消费一次，避免重复执行和结果重放。
3. **任务编排规则资产**
   - 去重、防抖、替换旧任务等规则属于业务策略，不是通用模型能力。
4. **调度语义**
   - Cron/定时触发与任务状态深度耦合，需由本地调度器保证。
5. **执行收敛**
   - Worker 的取消、重试、失败终态必须可预测且可审计。
6. **观测与运维**
   - WebUI 与状态快照依赖本地统一读模型，不能外包给对话层。

## 主 Session 方案

### 1) sessionId 恢复机制

目标：减少自研上下文拼装复杂度，提升会话连续性与稳定性。

- 为主会话持久化 `sessionId`。
- 启动优先恢复既有会话，失效时自动重建。
- 恢复失败不阻塞执行层，仅降级到新会话继续服务。

### 2) 主会话感知任务完成

目标：让主会话在异步任务完成后自动获得新上下文并继续决策。

- 提交任务时建立任务与主会话的关联关系。
- 任务完成后发布标准完成事件。
- 结果通知器将完成事件回注入主会话，驱动下一步回复或继续编排。
- 只有回注成功才确认消费完成，确保幂等与可恢复。

### 3) 主会话唤醒机制（含 Cron）

目标：让主会话在正确时机被唤醒，避免轮询与重复调度。

- 采用事件驱动唤醒，不采用固定轮询。
- 统一唤醒入口，接收三类事件：`user_input`、`task_done`、`cron_due`。
- 主会话执行采用单飞策略，同一时刻仅允许一个活跃运行。
- 若主会话正在运行，新事件进入待处理队列，避免并发重入。
- 唤醒事件必须持久化，处理成功后再确认消费，保证重启可恢复。

Cron 的默认策略：

1. `cron_due` 先触发本地执行层动作（创建任务、进入队列）。
2. 再按任务类型决定是否立即唤醒主会话：
   - 后台任务：不立即唤醒，等待 `task_done` 再回注主会话。
   - 提醒/交互任务：立即唤醒主会话，生成用户可见反馈。
3. 若主会话忙碌，Cron 事件只入队，不打断当前轮次。

设计原则：先保证执行层确定性，再决定会话层是否即时响应。

## 修改计划（一次性全量）

1. **一次性切换**
   - 新架构一次发布完成切换，不保留旧 manager 智能层的运行期兼容路径。
2. **不留兼容层**
   - 不做双跑、不做灰度分流、不保留旧链路兜底分支。
3. **上线前门槛**
   - 所有关键验证在发布前完成，达标后再执行全量切换。
4. **回退策略**
   - 若出现阻断问题，采用版本回滚与数据恢复，不通过兼容层过渡。

## 验证门槛（Go/No-Go）

- 任务集合语义与时序一致
- 取消/重试/失败行为一致
- Cron 触发一致
- 会话恢复成功率达标
- WebUI 无状态丢失或乱序
- 故障注入下系统可恢复

任一关键门槛不达标，不进入下一阶段。

## 预期收益

1. 降低 manager 智能层维护难度
2. 明确分层边界，减少职责混乱
3. 保留执行层确定性，提升系统可控性
4. 逐步减少冗余自研逻辑

## 主要风险

1. 会话与本地状态时序错位
2. 全量切换后行为偏差集中暴露
3. 回注机制异常导致主会话“感知滞后”
4. 迁移期观测口径不一致

风险应对原则：先完成发布前验证，再一次性切换；先保一致性，再追求删代码。

---

_更新时间：2026-02-14_
